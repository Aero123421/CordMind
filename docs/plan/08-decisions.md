# 実装計画書 08: 重要な意思決定（ADR）

## 記入ルール
- 1決定 = 1項目
- 背景 / 選択肢 / 決定 / 影響 を必ず書く

## ADR一覧
### ADR-001: Node.js + discord.js v14 を採用
- 背景: Discord API v10 への準拠と安定したライブラリが必要
- 選択肢: discord.js v14 / 他言語 SDK / 自前実装
- 決定: Node.js（最新 LTS）+ discord.js v14 を採用
- 影響: Node LTS 更新の追従が必要

### ADR-002: 永続化は Postgres 16
- 背景: 設定/監査ログ/状態管理を安全に保存したい
- 選択肢: SQLite / Redis / Postgres
- 決定: Postgres 16
- 影響: Docker で DB を同居、バックアップ運用が必要

### ADR-003: 1 依頼 = 1 Thread
- 背景: 会話の分離と監査性を高めたい
- 選択肢: メインチャンネル継続 / DM / Thread
- 決定: Thread を自動生成し会話を継続
- 影響: Thread 作成権限とアーカイブ設定が必要

### ADR-004: Tool Allowlist + 破壊的操作の二段階確認
- 背景: 誤操作やプロンプト注入リスクの低減
- 選択肢: 全操作許可 / Allowlist / 人手承認
- 決定: Allowlist + UI で confirm/reject
- 影響: 影響範囲表示と確認 UI 実装が必要

### ADR-005: API キーは AES-256-GCM で暗号化保存
- 背景: 平文保管を避けたい
- 選択肢: 平文 / KMS / アプリ側暗号化
- 決定: アプリ側 AES-256-GCM
- 影響: キー管理手順と復号失敗時の復旧が必要

### ADR-006: Structured Output を優先し、未対応は JSON モードで補完
- 背景: LLM 出力の安全性と Tool 実行の確実性
- 選択肢: すべて JSON モード / Schema 強制 / 文字列解析
- 決定: 対応プロバイダーは JSON Schema を強制し、未対応は JSON モード + バリデーション
- 影響: プロバイダー別の分岐と再試行ロジックが必要

### ADR-007: 破壊的操作は原則許可、特定操作は禁止
- 背景: 管理用途を広くカバーしたいが、自己破壊操作は避けたい
- 選択肢: 破壊的操作を全禁止 / 例外許可 / 例外禁止
- 決定: 原則許可、ただし「サーバー削除」「Bot 自身の BAN/Kick/Timeout」は禁止
- 影響: ルールベースの禁止リスト実装が必要

### ADR-008: 設定フローの順序を固定
- 背景: 初回設定時の迷いを減らしたい
- 選択肢: 任意順 / プロバイダー→API→モデル / モデル→API→プロバイダー
- 決定: 「プロバイダー選択 → API 入力 → モデル選択」
- 影響: API 設定済みの場合の分岐 UI が必要

### ADR-009: Thread 内はメンション不要で会話する
- 背景: Thread では自然な会話体験を提供したい
- 選択肢: 毎回メンション必須 / Thread 内はメンション不要 / UI 入力必須
- 決定: Thread 内はメンション不要とし、Message Content Intent を有効化する
- 影響: 開発者ポータルでの Intent 有効化と起動時チェックが必要
