# 実装計画書 10: エージェント設計（Context/Prompt/Workflow）

## 目的
- “チャンネル操作だけ” に偏らず、Discord で Bot ができる主要操作を横断して扱える「自律的な AI エージェント」を実装するための設計指針を固める
- ユーザー体験として「Bot が自分で現状を確認して進める」「必要なときだけ質問する」「破壊的操作は分かりやすく確認する」を実現する

本書は「大量のユースケースを列挙して設計する」方針は取らず、設計/実装の抽象度を上げて “多くのタスクをカバーできる” 構造を作ることに集中する。

## 設計原則
- 観測優先: 実行前に read-only ツールで現状確認する（ID をユーザーに要求しない）
- 最小質問: 不足情報だけを短く聞き、可能なら選択肢（UI）で確定する
- 逐次実行: actions[] をまとめつつも、部分成功・途中失敗を前提に進める
- 承認の一貫性: destructive は必ず human approval。禁止事項はハード拒否
- 言語一貫: ギルド言語（英/日）に合わせてユーザー向け文面を統一する
- untrusted input 分離: ユーザー入力・ツール出力は untrusted として扱い、system/developer 指示に混ぜない（根拠は docs/plan/02-research.md）

## ワークフロー（観測→計画→実行→再計画）
### ステップ設計（最大 N ステップ）
1. **Observe**（観測）: list/search/get 詳細などの read-only を 1〜2 回実行して状況を把握
2. **Plan**（計画）: 構造化出力で「質問（clarifications[]）/actions[]/destructive 判定/理由/影響」を生成
3. **Ask**（必要時のみ）: 不足情報があれば質問。候補が複数ある場合は “候補提示→選択” にする
4. **Approve**（必須）: destructive または “承認必須カテゴリ” の操作は Accept/Reject を要求
5. **Act**（実行）: 許可済み actions[] を順次実行（レート制限、バックオフ、部分成功）
6. **Verify**（検証）: 成功/失敗を観測し、必要なら 1 に戻る

### 停止条件（暴走防止）
- ループ上限（例: 6）
- 同一観測（同一パラメータ）を繰り返したら打ち切り
- actions[] の上限（例: 10）
- destructive の連続実行を抑制（レート制限 + 分割）

## Context engineering（入力の組み立て）
### 入力に含めるもの（推奨）
- **固定**（system 相当）:
  - Bot の役割、許可/禁止、承認フロー、言語ルール
  - ツールの使い方（観測優先、候補提示→確定、ID要求しない）
- **動的**:
  - ギルド設定（言語、プロバイダー、モデル、レート制限、管理ロール、ログ設定）
  - 依頼者情報（user_id、権限判定結果）
  - Thread 状態（短い要約、直近の決定、未解決の質問）
  - 直近 N 件の会話（上限を厳格に）
  - 直近のツール結果（全文ではなく “要約+必要 ID 群”）

### 入力に含めないもの（推奨）
- ユーザーの長文をそのまま system/developer 指示に混ぜる
- 大量のツール出力をそのまま貼る（コンテキストを圧迫し、注入/誤誘導の温床になる）

### まとめ（要約）戦略
- Thread ごとに “短い要約” を常に最新化する（「誰が」「何を」「何が未確定か」「確定した制約」）
- 要約は次を優先して残す:
  - 禁止/承認必須の制約
  - 対象リソースの ID（確定済みのもののみ）
  - 進行中タスクの残タスク
  - 直近の失敗原因（権限不足/対象なし/レート制限など）

## Prompt engineering（出力の作り方）
### 構造化出力（必須）
- LLM は “自由文で考える” のではなく、最終的に必ず次を返す:
  - `clarifications[]`: 質問（必要なときだけ）
  - `actions[]`: 実行したいツール呼び出し（複数可）
  - `destructive`: 破壊的（承認必須）か
  - `reason`: その判断理由（短く）
  - `expected_impact`: 影響（対象/変更点）

### 質問の作法（最小質問）
- 質問は 1 回に 1〜2 個まで
- 可能なら “選択肢” を提示（例: 候補のチャンネル/ロール/ユーザーを 3〜10 件出す）
- 質問の中で “操作案” も同時に示す（ユーザーが Accept しやすい）

### 言語の作法
- ユーザー向け文面は設定言語に統一（英/日）
- 構造化部分（スキーマキーやツール名）は英語でもよいが、ユーザーに見せる部分は翻訳する

## Human approval（確認 UI）設計
### 表示（JSON を出さない）
- 「これから行うこと」を 1 行×複数行で要約（例: “Rename channel <#...> → vc3”）
- “なぜそれをするか” を 1 行で添える（省略可）
- “影響範囲” を短く列挙（チャンネル/ロール/メンバー）
- 承認ボタン: Accept / Reject

### 承認できる人
- 依頼者のみ

## ツール設計（多用途にするための最小セット）
ユースケースを列挙せずにカバー範囲を増やすには、まず “観測” を強くする。

- 観測（read-only）
  - チャンネル/ロール/メンバーの一覧・検索・詳細
  - 権限（オーバーライド）の表示
  - 既存リソースの現在値（名前、カテゴリ、ユーザー上限など）
- 変更（write）
  - 主要リソースの作成/更新
  - ロール付与/剥奪
- 破壊的（destructive）
  - 削除、権限の大きな変更、メンバー管理（BAN/KICK/TIMEOUT 等）

## 失敗時の UX（“Failed to interpret” を減らす）
- まず Bot 側で観測し、推定できる対象があるなら候補を提示する
- それでも解釈できない場合:
  - “できること” を短く提示（チャンネル/ロール/メンバー/権限…）
  - 例文を 2〜3 個出す
  - 次の質問は 1 つに絞る

## 検証（評価/回帰防止）
- 代表ログを少数（10〜30）に絞ってフィクスチャ化し、改善のたびに成功率を比較する
- 指標（例）
  - 解釈失敗率
  - “ID を要求した回数”
  - 言語逸脱率（日本語設定で英語が出た）
  - 承認必須なのに即実行した割合（0 が目標）

## 関連資料
- docs/plan/02-research.md（Agentic / Safety / Evaluation の一次ソース）
- docs/plan/03-architecture.md（全体構成）
- docs/plan/04-implementation.md（改善タスク分割）
