# 実装計画書 04: 実装計画

## 前提（この計画のスコープ）
- 本リポジトリは既に MVP 相当の実装が存在するため、本書は「エージェンティック化 + UX 改善 + 安全性/整合性の強化」を中心にした改善計画とする
- コード変更は tool/agent/UX/安全性に集中し、不要な再設計は避ける

## フェーズ分割
- Phase 0: 現状把握と回帰防止（ログ/テスト/計測）
- Phase 1: UX/i18n の整合性（英/日、setup/setting の導線）
- Phase 2: エージェント実行ループ（観測→計画→実行→再計画）
- Phase 3: Tool カバレッジ拡張（チャンネル偏重の解消）
- Phase 4: 安全フロー強化（human approval、要約表示、禁止/承認ルール）
- Phase 5: レート制限/再試行/部分成功の取り扱い
- Phase 6: 評価（Evals）と運用品質（観測/デバッグ容易性）

## 主要タスク（AI実装向け粒度）
- Phase 0（現状把握と回帰防止）
  - 「解釈に失敗しました / Failed to interpret」発生条件をログから特定し、再現手順を作る
  - 代表的な失敗パターン（ID要求、英語返答混入、確認 UI が JSON になる）を回帰テスト項目として固定する
  - “ツール呼び出し履歴/結果” を短い形で出力できるデバッグモード（設定で ON/OFF）を設ける
- Phase 1（UX/i18n の整合性）
  - 言語設定を全ユーザー向け文面の単一ソースにする（例外/フォールバック文言を消す）
  - `/discordaimanage setup` のステップを「言語 → プロバイダー → API → モデル → 完了」に固定し、すべてに Next/戻る/キャンセルを用意する
  - `/discordaimanage setting` は “現在値 + 変更” に寄せ、再設定時も同じ導線で完結する
  - API キー画面で「このプロバイダーのキーが設定される」ことを明示（設定済み/未設定、再設定ボタン）
  - モデル表示は必ず provider label を併記し、同名モデルがあっても混同しない
- Phase 2（エージェント実行ループ）
  - “観測ツール” と “実行ツール” を明確に分け、最初に観測してから決める既定動作にする
  - LLM 出力スキーマを「質問（clarifications[]）/提案 actions[]/destructive 判定/理由/想定影響」に統一し、欠損時は正規化して扱う
  - ループの停止条件（最大ステップ、同一観測の繰り返し、失敗時の縮退）を仕様化する
  - “ユーザーに聞くべきこと” は最小化し、選択肢（ボタン/セレクト）で提示できる形式に寄せる
- Phase 3（Tool カバレッジ拡張）
  - チャンネル以外の主要リソースを “観測→変更→破壊的” の粒度で揃える
    - メンバー: 検索/詳細取得/ロール付与/剥奪/タイムアウト/解除/BAN/KICK
    - ロール: 一覧/作成/変更/削除（削除は destructive）
    - 権限: 対象（チャンネル/ロール/メンバー）ごとの権限上書きの表示/更新（更新は destructive 扱い推奨）
  - 対象指定は「メンション/ID/部分一致検索」を許容し、Bot 側で候補を出して確定させる
- Phase 4（安全フロー強化）
  - 禁止: delete_guild、自己/ボットへの BAN/KICK/TIMEOUT を強制拒否（LLM 指示では上書き不可）
  - 承認必須: destructive + メンバー管理（BAN/KICK/TIMEOUT/ロール剥奪等）をデフォルト承認必須にする
  - 承認 UI は JSON を出さず、人間が読める “要約 + 対象 + 影響” を表示（必要なら詳細表示ボタン）
  - 承認ボタン（Accept/Reject）の権限は「依頼者のみ」を仕様とし、実装で強制する
- Phase 5（レート制限/再試行/部分成功）
  - destructive rate limit の既定値を 3/分（要調整）に設定し、超過時 UX（待機/確認のみ/分割実行）を定義する
  - まとめ実行（actions[]）は「部分成功」を前提にし、成功/失敗を個別に返す
  - Discord API の権限不足/存在しない対象/レート制限を分類して、次に取れる行動（観測や質問）へつなげる
- Phase 6（評価と運用品質）
  - 代表的な会話ログを “評価用フィクスチャ” として保存（機密を含めない形に整形）
  - 失敗率（解釈失敗、ID要求、言語逸脱、誤 tool 呼び出し）を指標化し、改善のたびに比較できるようにする
  - LLM 依存の挙動は “プロバイダー別” に評価し、最低ラインを割り込んだ場合のフォールバックを決める

## 依存関係
- 言語/i18n → すべての UX の前提
- 観測ツールの充実 → “ID をユーザーに要求しない” UX の前提
- 承認 UI の権限仕様 → 誤実行の抑止に直結
- 評価/回帰テスト → 体感品質（エージェンティックさ）の改善速度に直結

## マイルストーン
- M0: 回帰テスト観点と計測指標が確定
- M1: setup/setting の UX と i18n が崩れない状態になる
- M2: 観測→再計画ループで “ID 要求” がほぼ消える
- M3: チャンネル/ロール/メンバーの主要操作が横断的に扱える
- M4: 確認 UI が読みやすく安全（承認者/禁止/承認必須が一貫）
- M5: レート制限・部分成功の UX が破綻しない
- M6: 代表ログで成功率が改善し、回帰しない

## クリティカルパス
- 権限チェック → 観測 → LLM 構造化出力 →（必要なら承認）→ Tool 実行 → 検証 → 監査ログ

## 作業順序（直近1〜3ステップ）
- 1) “承認者” と “禁止/承認必須” の最終仕様を確定
- 2) 観測ツールを揃え、ID 要求をしない導線を徹底する
- 3) 代表ログ（失敗例）をフィクスチャ化し、改善の評価指標を回す

## 受け入れ基準（DoD）
- 管理者/指定ロールのみが操作できる（承認ボタンも含む）
- Thread 生成と継続会話が成立（日本語設定なら日本語で応答し続ける）
- “ID を教えて” が基本的に出ない（Bot が観測で自己解決する）
- 破壊的操作は確認 → 実行 → 監査ログが通る（表示は人間向け要約）
- 自己/ボットへの BAN/KICK/TIMEOUT とサーバー削除は実行できない
- `/discordaimanage setup` / `setting` でプロバイダー/モデル/API キー設定が迷わずできる
