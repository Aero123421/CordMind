# 改善計画（2026-01-21）

## 方針
- 目的: “自律的に多様な Tool を使うマルチステップ” を体感できるエージェントへ。
- 範囲: エージェント実行ループ/観測/曖昧解消/安全性/評価。

## 優先度 P0（エージェンティック中核）
1) **LLM 出力スキーマの再設計**
   - 例: { clarifications[], actions[], destructive, reason, expected_impact }
   - 対応: src/conversation/schema.ts / plan.ts / handler.ts / prompt
   - 受け入れ基準:
     - LLM が理由/影響を毎回返せる。
     - ask/act の分岐が安定する。

2) **観測→計画→実行→再計画のループ化**
   - observe を複数回許容（observations[]）し、plan→act→verify を明示。
   - 受け入れ基準:
     - 代表シナリオで “観測→実行→確認” が最低 1 回発生。

3) **曖昧対象の解消（ID 要求の排除）**
   - ツールが候補を返せるよう構造化（candidates[]）。
   - UI で選択（Select/Buttons）を提示。
   - 受け入れ基準:
     - “user_id/mention を提示してください” の露出が大幅減。

4) **観測ツールの不足補完**
   - 例: チャンネル権限上書きの取得 / ロール詳細の強化 / カテゴリ構造取得。
   - 受け入れ基準:
     - 権限変更前に状態確認が可能。

## 優先度 P1（安定性/文脈強化）
5) **動的コンテキスト注入**
   - 権限/設定/直近の重要決定/既知 ID を system または tool memory に追加。
   - 受け入れ基準:
     - 同一 Thread 内で “同じ質問の繰り返し” が減る。

6) **ループ停止条件の強化**
   - 同一観測の反復や連続失敗で停止/質問へ切替。
   - 受け入れ基準:
     - 無限ループ相当の挙動が発生しない。

7) **destructive レート制限の見直し**
   - 既定値を安全側へ（計画値に合わせる or 設定化）。
   - 受け入れ基準:
     - 連続破壊操作時に UX が破綻しない。

## 優先度 P2（運用・評価）
8) **Evals/回帰テスト**
   - 代表ログをフィクスチャ化し、成功率/ID 要求率/言語逸脱率を測定。
   - 受け入れ基準:
     - 改善前後の数値比較ができる。

9) **デバッグモード**
   - 観測/計画/実行のサマリを短く出力できる設定。

## 直近の提案順序（安全）
1. スキーマ/ループ再設計（P0-1/2）
2. 曖昧解消 UI（P0-3）
3. 観測ツール追加（P0-4）
4. コンテキスト強化・停止条件（P1-5/6）
5. 評価/回帰（P2-8）
